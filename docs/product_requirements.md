## 云文档自动处理功能 - 需求说明

### 一、背景与目标

在飞书云文档（Docs）中，用户完成一篇文档创作后，希望能够：

- **自动对文档内容进行处理**（如总结、结构化拆解、生成任务 / 报告等），减少手工整理成本。
- **将处理结果写入一个“子文档”中**，形成可单独阅读和复用的成果。
- **在原文档中增加到子文档的关联/入口**，方便跳转。
- **自动通知相关用户**（至少是文档作者 / 触发者），告知处理完成。

同时希望：

- 支持多种触发方式（在文档中点击小组件按钮、通过打标签自动触发等）。
- 把“文档处理逻辑”尽量抽象成一个后端接口（FastAPI），前端 / 触发方式多样化但共用同一后台能力。

---

### 二、核心用户场景

- **场景 1：用户在文档中主动触发处理（小组件按钮）**
  - 用户在云文档中完成内容撰写。
  - 在文档中通过「+」菜单或「/」命令插入一个**云文档小组件（Docs add-on）**。
  - 在小组件的 UI 中点击「生成分析子文档」按钮。
  - 系统获取当前文档内容，调用后端处理：
    - 生成分析结果。
    - 创建一个子文档并写入结果。
    - 在原文档中插入指向子文档的链接。
    - 通过飞书消息或卡片向触发者发送“处理完成”通知。

- **场景 2：用户通过“打标签”自动触发处理**
  - 团队约定一种“自动处理标签”规则，例如：
    - 文档标题包含 `[自动处理]` 或 `[auto]`。
    - 正文中存在某个特殊标记块，如 `#auto_process`。
  - 用户写完文档后，只需打上约定标签，不必点额外按钮。
  - 应用在后台订阅文档更新事件：
    - 当检测到某文档新增/满足标签规则时，自动触发处理流程。
    - 处理逻辑与场景 1 共用。
  - 处理完成后，同样创建子文档、更新原文档并通知相关用户。

---

### 三、系统角色与形态

- **飞书企业自建应用**
  - 开启「云文档小组件（Docs add-on）」能力。
  - 开启必要的文档读写与消息发送权限。
  - 作为统一身份，调用飞书 OpenAPI 进行文档和消息操作。

- **云文档小组件前端（Docs add-on）**
  - 插入到云文档正文中的“正文小组件”。
  - 提供触发 UI（按钮 / 参数选择等）。
  - 能够：
    - 识别当前文档信息（文档 ID、用户信息等）。
    - 通过前端调用后端接口发起处理请求。
    - 在必要时展示处理状态（等待中 / 成功 / 失败）。

- **后端服务（FastAPI）**
  - 部署在可被飞书和小组件访问的服务器上。
  - 职责：
    - 安全持有 `app_id` / `app_secret`，负责获取/刷新 `tenant_access_token`。
    - 暴露 HTTP 接口供：
      - 小组件前端调用（显式触发）。
      - 飞书事件回调调用（标签自动触发）。
      - 飞书交互卡片回调调用（如有）。
    - 实现统一的文档处理流程：
      - 读取文档内容（从 OpenAPI 或由前端传入）。
      - 调用内部“算法 / AI”接口处理文档。
      - 创建子文档并写入结果。
      - 更新原文档（插入链接等）。
      - 发送消息或卡片通知用户。

---

### 四、功能需求（按优先级）

#### 4.1 第一阶段（MVP）

- **触发方式：**
  - 在云文档中插入 Docs add-on 正文小组件。
  - 小组件中提供一个简单按钮「生成子文档」。

- **处理逻辑：**
  - 必须支持从当前文档获取全文内容（可由前端或后端完成）。
  - 调用后端的“文档处理接口”，传入：
    - 文档内容（必选）。
    - 文档 ID（建议）。
    - 触发者用户 ID。
    - 可选参数（如处理模式）。
  - 后端完成：
    - 调用算法 / AI 服务得到结构化结果。
    - 创建一个新的云文档作为“子文档”，写入结果。
    - 在原文档中插入指向子文档的链接块。
    - 向触发者（可选：文档所有者）发送一条“处理完成”消息（文本或卡片）。

- **异常与状态：**
  - 小组件需要能展示基础状态：
    - 正在处理中（可简单提示“处理中，请稍候……”）。
    - 成功：展示子文档链接。
    - 失败：展示错误信息简要说明，并允许“重试”。

#### 4.2 第二阶段（增强）

- **新增触发方式：标签自动触发**
  - 支持约定标签规则（标题 / 正文标记）。
  - 后端订阅相关文档事件：
    - 例如文档标题变更 / 文档内容变更事件。
  - 当检测到标签满足条件时：
    - 自动调用与第一阶段相同的处理流程。
    - 需防止重复触发（可通过状态记录 / 去重机制）。

- **消息通知增强：**
  - 使用交互卡片作为通知载体，在卡片中：
    - 显示子文档标题及链接。
    - 可提供“重新生成”“打开原文档”等按钮。

#### 4.3 第三阶段（可选）

- **丰富小组件交互：**
  - 支持在小组件中选择处理模式（总结 / 任务拆解 / 报告等）。
  - 使用附属视图（全屏 / 悬浮卡片 / 弹窗 / 模态框）展示更丰富的界面和结果。

- **多文档或批量处理：**
  - 从小组件中选择其他文档进行处理。

---

### 五、非功能需求

- **安全性**
  - 后端不得在前端暴露 `app_secret`、`tenant_access_token` 等敏感信息。
  - 小组件前端仅通过 HTTPS 与后端通信。

- **性能**
  - 单次处理文档的等待时间尽量控制在可接受范围（如 < 10 秒），否则需在小组件 UI 中明确提示“后台处理中，将通过消息通知结果”。

- **可配置性**
  - 未来可以在后端维护“处理策略配置”，不需要频繁改小组件代码。

---

### 六、后续文档

- `frontend_docs_addon_design.md`：云文档小组件前端设计与开发需求。
- `backend_fastapi_design.md`：后端 FastAPI 服务设计与开发需求。


